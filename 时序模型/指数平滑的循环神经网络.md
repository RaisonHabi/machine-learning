本文来源于文献：Slawek Smyl (2020). A hybrid method of exponential smoothing and recurrent neural networks for time series forecasting. International Journal of Forecasting. 
## 前言
在过去的数年间，我们见证了神经网络模型和其他机器学习模型的蓬勃发展，这些模型在众多应用领域取得了巨大成功，这其中包括图像/语音识别、自然语言处理、自动驾驶甚至网络游戏。但不得不说，这些成功在一定程度上得益于机器学习本身良好的应用机制：给定一组规模庞大且具有代表性的数据集，机器学习能学会辨识复杂的非线性模式，并探索非结构化关系。因此，机器学习并不局限于一般性假设甚至预设的数据生成过程，它能让数据自己说话。

近年来研究发现，尽管机器学习模型在一些预测问题上已经取得了一定的成功，例如能源预测，但就一般性的时间序列而言，机器学习模型的性能有时会低于人们的预期。

一般而言，机器学习应用于预测问题时主要在交叉学习 (cross-learning) 上体现优势，即借助多个时间序列训练一个模型，而这一点恰恰与标准的统计时间序列模型 (standard statistical time series models) 不同，统计时间序列模型能对每个单独的时间序列构建模型。另外，对于神经网络而言，它的预测性能在很大程度上取决于时间序列数量和观测样本数量。

在这里，作者 Slawek Smyl 提出了一种混合模型，这种模型能结合指数平滑 (exponential smoothing，属于统计时间序列模型) 和循环神经网络 (recurrent neural network, RNN，属于机器学习模型) 各自的建模优势，并有助于提升时间序列预测性能。在此之前，作者将这个模型应用于M4 forecasting competition (一项针对预测问题的数据挖掘赛事)，已经取得了优异的成绩。

&nbsp;
## 动机
指数平滑和循环神经网络的混合模型能为预测问题提供精准的预测结果，它比单独用指数平滑或是循环神经网络获得的结果都要好。从模型构成上看，主要包括：
```
消除季节性因素 (deseasonalization)
自适应归一化 (adaptive normalization)
生成预测值 (generation of forecasts)
集成 (ensembling)
```
前两项可通过 state space 指数平滑实现。一般而言，这里使用随机梯度下降便可对初始季节性参数 (seasonality components)、平滑系数 (smoothing coefficients)、神经网络权重进行拟合。有了这些参数，便可用于消除季节性因素和自适应归一化。

在 M4 forecasting competition 中，由于时间序列都是以向量的形式给出，并没有标注相应的时间戳，加之这些时间序列的季节性模式都大不相同，因此消除季节性因素在这里显得尤为重要。

第三项生成预测值是由神经网络实现的，输出结果前需确保给定预测步长，例如输出未来18个时间戳的预测值。第四项是将已有的预测值进行集成，这个过程可保证模型的稳健性 (robustness)、缓解参数的不稳定性 (uncertainty)。

鉴于此，指数平滑和循环神经网络混合模型的两个特点为：
```
这种混合模型能结合统计时间序列模型 (即指数平滑) 和机器学习模型 (即循环神经网络)；
这种混合模型在本质上是双层模型，能运用全局和局部参数确保交叉学习过程。
```

&nbsp;

<h2>3 模型表达式</h2><p><b>3.1 消除季节性因素</b></p><p>在 M4 forecasting competition 给定的时间序列中，即使是频率相同的时间序列都可能带有不同的季节性模式。除此之外，时间序列数据并未提供相应的起止日期。在这种情况下，神经网络几乎不可能处理时间序列中的季节性因素。当然，一种行之有效的策略是运用消除季节性因素算法如指数平滑对时间序列进行预处理。</p><p><b>3.2 指数平滑的数学表达式</b></p><p>指数平滑有如下几种经典形式：</p><ul><li><b>non-seasonal 模型</b>：</li></ul><p><img src="https://www.zhihu.com/equation?tex=l_%7Bt%7D%3D%5Calpha+y_%7Bt%7D%2B%281-%5Calpha%29+l_%7Bt-1%7D" alt="l_{t}=\alpha y_{t}+(1-\alpha) l_{t-1}" eeimg="1"/> </p><ul><li><b>single seasonality 模型</b>：</li></ul><p><img src="https://www.zhihu.com/equation?tex=%5Cleft%5C%7B%5Cbegin%7Baligned%7D+%26l_%7Bt%7D%3D%5Calpha+y_%7Bt%7D+%2F+s_%7Bt%7D%2B%281-%5Calpha%29+l_%7Bt-1%7D%5C%5C+%26s_%7Bt%2BK%7D%3D%5Cbeta+y_%7Bt%7D+%2F+l_%7Bt%7D%2B%281-%5Cbeta%29+s_%7Bt%7D+%5Cend%7Baligned%7D+%5Cright." alt="\left\{\begin{aligned} &amp;l_{t}=\alpha y_{t} / s_{t}+(1-\alpha) l_{t-1}\\ &amp;s_{t+K}=\beta y_{t} / l_{t}+(1-\beta) s_{t} \end{aligned} \right." eeimg="1"/> </p><ul><li><b>double seasonality 模型</b>：</li></ul><p><img src="https://www.zhihu.com/equation?tex=%5Cleft%5C%7B+%5Cbegin%7Barray%7D%7Bl%7D+l_%7Bt%7D%3D%5Calpha+y_%7Bt%7D+%2F%5Cleft%28s_%7Bt%7D+u_%7Bt%7D%5Cright%29%2B%281-%5Calpha%29+l_%7Bt-1%7D+%5C%5C+s_%7Bt%2BK%7D%3D%5Cbeta+y_%7Bt%7D+%2F%5Cleft%28l_%7Bt%7D+u_%7Bt%7D%5Cright%29%2B%281-%5Cbeta%29+s_%7Bt%7D+%5C%5C+u_%7Bt%2BL%7D%3D%5Cgamma+y_%7Bt%7D+%2F%5Cleft%28l_%7Bt%7D+s_%7Bt%7D%5Cright%29%2B%281-%5Cgamma%29+u_%7Bt%7D+%5Cend%7Barray%7D+%5Cright." alt="\left\{ \begin{array}{l} l_{t}=\alpha y_{t} /\left(s_{t} u_{t}\right)+(1-\alpha) l_{t-1} \\ s_{t+K}=\beta y_{t} /\left(l_{t} u_{t}\right)+(1-\beta) s_{t} \\ u_{t+L}=\gamma y_{t} /\left(l_{t} s_{t}\right)+(1-\gamma) u_{t} \end{array} \right." eeimg="1"/> </p><p>其中， <img src="https://www.zhihu.com/equation?tex=y_%7Bt%7D" alt="y_{t}" eeimg="1"/> 表示时间序列时刻 <img src="https://www.zhihu.com/equation?tex=t" alt="t" eeimg="1"/> 的具体数值； <img src="https://www.zhihu.com/equation?tex=l_t%2Cs_t%2Cu_t" alt="l_t,s_t,u_t" eeimg="1"/> 分别表示水平参数 (level)、季节性参数 (seasonality component)、额外季节性参数 (second seasonality component)； <img src="https://www.zhihu.com/equation?tex=K" alt="K" eeimg="1"/> 表示每个“季节性”观测值的数量，例如 <img src="https://www.zhihu.com/equation?tex=K%3D4" alt="K=4" eeimg="1"/> 表示一年中有4个季节， <img src="https://www.zhihu.com/equation?tex=K%3D12" alt="K=12" eeimg="1"/> 表示一年中有12个月， <img src="https://www.zhihu.com/equation?tex=K%3D52" alt="K=52" eeimg="1"/> 表示一年中有52个星期； <img src="https://www.zhihu.com/equation?tex=L" alt="L" eeimg="1"/> 表示每个“额外季节性”观测值的数量，例如 <img src="https://www.zhihu.com/equation?tex=L%3D168" alt="L=168" eeimg="1"/> 表示每周有168个小时。</p><p>在这里， <img src="https://www.zhihu.com/equation?tex=s_t%2Cu_t" alt="s_t,u_t" eeimg="1"/> 是正数；平滑系数 <img src="https://www.zhihu.com/equation?tex=%5Calpha%2C%5Cbeta%2C%5Cgamma" alt="\alpha,\beta,\gamma" eeimg="1"/> 取值在0到1之间；这些约束可通过如下操作完成：</p><ol><li>对季节性参数做初始化时，使用 <img src="https://www.zhihu.com/equation?tex=%5Ctext%7Bexp%7D%28%29" alt="\text{exp}()" eeimg="1"/> 函数；</li><li>把 <img src="https://www.zhihu.com/equation?tex=%5Ctext%7Bsigmoid%7D%28%29" alt="\text{sigmoid}()" eeimg="1"/> 应用在平滑系数的超参数上。</li></ol><p><b>3.3 on-the-fly 预处理</b></p><p>在每个时间序列中，有了计算得到的各个时刻下的水平参数和季节性参数，on-the-fly预处理过程能对时间序列消除季节性因素、自适应归一化。</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-e7575679249a6d5a7ac845e5e33484b3_b.jpg" data-size="normal" data-rawwidth="3098" data-rawheight="1453" class="origin_image zh-lightbox-thumb" width="3098" data-original="https://pic4.zhimg.com/v2-e7575679249a6d5a7ac845e5e33484b3_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;3098&#39; height=&#39;1453&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="3098" data-rawheight="1453" class="origin_image zh-lightbox-thumb lazy" width="3098" data-original="https://pic4.zhimg.com/v2-e7575679249a6d5a7ac845e5e33484b3_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-e7575679249a6d5a7ac845e5e33484b3_b.jpg"/><figcaption>以月份为时间粒度的时间序列</figcaption></figure><p><b>3.4 神经网络预测</b></p><p>以上我们知道，神经网络是作用在已经消除季节性因素、进行自适应归一化的数值上，因此，在输出预测值时还需要做以下变换：</p><ul><li>对于 non-seasonal 模型：</li></ul><p><img src="https://www.zhihu.com/equation?tex=%5Chat%7By%7D_%7Bt%2B1+.+.+t%2Bh%7D%3D%5Cexp+%28N+N%28x%29%29+%2A+l_%7Bt%7D" alt="\hat{y}_{t+1 . . t+h}=\exp (N N(x)) * l_{t}" eeimg="1"/> </p><ul><li>对于 single seasonality 模型：</li></ul><p><img src="https://www.zhihu.com/equation?tex=%5Chat%7By%7D_%7Bt%2B1+.+.+t%2Bh%7D%3D%5Cexp+%28N+N%28x%29%29+%2A+l_%7Bt%7D+%2A+s_%7Bt%2B1%3A+.+.+t%2Bh%7D" alt="\hat{y}_{t+1 . . t+h}=\exp (N N(x)) * l_{t} * s_{t+1: . . t+h}" eeimg="1"/> </p><p>对于 dual seasonality 模型：</p><p><img src="https://www.zhihu.com/equation?tex=%5Chat%7By%7D_%7Bt%2B1+.+.+t%2Bh%7D%3D%5Cexp+%28N+N%28x%29%29+%2A+l_%7Bt%7D+%2A+s_%7Bt%2B1%3A+.+.+t%2Bh%7D+%2A+u_%7Bt%2B1%3A+.+.+t%2Bh%7D" alt="\hat{y}_{t+1 . . t+h}=\exp (N N(x)) * l_{t} * s_{t+1: . . t+h} * u_{t+1: . . t+h}" eeimg="1"/> </p><p>其中，向量 <img src="https://www.zhihu.com/equation?tex=x" alt="x" eeimg="1"/> 是通过预处理的输入； <img src="https://www.zhihu.com/equation?tex=NN%28x%29" alt="NN(x)" eeimg="1"/> 是神经网络的输出，也是一个向量； <img src="https://www.zhihu.com/equation?tex=l%28t%29" alt="l(t)" eeimg="1"/> 表示时刻 <img src="https://www.zhihu.com/equation?tex=t" alt="t" eeimg="1"/> 的水平参数数值； <img src="https://www.zhihu.com/equation?tex=h" alt="h" eeimg="1"/> 表示预测步长 (forecasting horizon)。整个预测机制如下图所示。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-223c9ad07c678f656f02b30d5ff55d38_b.jpg" data-size="normal" data-rawwidth="2512" data-rawheight="1364" class="origin_image zh-lightbox-thumb" width="2512" data-original="https://pic1.zhimg.com/v2-223c9ad07c678f656f02b30d5ff55d38_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;2512&#39; height=&#39;1364&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2512" data-rawheight="1364" class="origin_image zh-lightbox-thumb lazy" width="2512" data-original="https://pic1.zhimg.com/v2-223c9ad07c678f656f02b30d5ff55d38_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-223c9ad07c678f656f02b30d5ff55d38_b.jpg"/><figcaption>整个预测机制的系统架构</figcaption></figure><p><b>3.5 神经网络架构</b></p><p>为了更好地理解实现过程，这里可以将整个预测机制所涉及的参数归为以下三类：</p><ul><li><b>局部常数</b> (local constants)。这些参数能反映单个时间序列的行为，它们不随预测过程而改变。在这里，指数平滑模型中的平滑参数就是一个局部常数。</li><li><b>局部状态</b> (local states)。这些参数是随着预测过程发生改变的，即时变参数。举例来说，水平参数和季节性参数都是局部状态。</li><li><b>全局常数</b> (global constants)。这些参数用于反映多个时间序列的模式，它们不随预测过程而改变，也能视为常数。在这里，神经网络中的权重都是全局常数。</li></ul><p>一般而言，统计时间序列模型常常作用于单个时间序列，意味着这类模型只能兼具局部常数和局部状态。但机器学习能同时作用于多个时间序列，可以训练出全局常数。更有甚者，混合模型能训练得到局部常数、局部状态、全局常数三者。</p><p>就神经网络架构而言，下图给出了配置神经网络的三个例子，第一个例子是对于以季节为时间粒度的时间序列做出预测，第二个例子是对于以月为时间粒度的时间序列做出预测，第三个例子是对于以年为时间粒度的时间序列做出预测。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-56b791b891051a9b607da617caf1e5fc_b.jpg" data-size="normal" data-rawwidth="2513" data-rawheight="1317" class="origin_image zh-lightbox-thumb" width="2513" data-original="https://pic1.zhimg.com/v2-56b791b891051a9b607da617caf1e5fc_r.jpg"/></noscript><img src="data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;2513&#39; height=&#39;1317&#39;&gt;&lt;/svg&gt;" data-size="normal" data-rawwidth="2513" data-rawheight="1317" class="origin_image zh-lightbox-thumb lazy" width="2513" data-original="https://pic1.zhimg.com/v2-56b791b891051a9b607da617caf1e5fc_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-56b791b891051a9b607da617caf1e5fc_b.jpg"/><figcaption>预测模型的神经网络架构</figcaption></figure><h2>

## References
[时间序列分析 | 指数平滑的循环神经网络 (exponential smoothing RNN)](https://zhuanlan.zhihu.com/p/116553899)
