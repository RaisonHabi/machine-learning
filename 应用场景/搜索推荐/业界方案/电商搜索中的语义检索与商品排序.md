### 1.背景介绍
一个典型电商搜索引擎的架构，包括三个重要组成部分： query 理解、召回和排序。
```
Query 理解：包括 query 的纠错、改写、扩展、分词等。

召回阶段：给定一个查询词，从商品库中召回有效正确的商品候选集，并将结果返回给排序。
召回方式有很多种，这里我们只介绍基于向量检索的召回。

排序阶段：给定召回商品的候选集合，根据众多因子对这些商品进行排序，挑选出最好的候选商品展示给用户。
```

### 2.向量召回
向量检索作为一种信息检索方式在工业界已经被广泛应用，它能解决传统倒排检索不能解决的问题。  

倒排通过字面匹配方式召回商品，这种方式存在一种缺陷，不能召回字面不匹配但语义层面相近的商品， 如 query='2-3 周岁宝宝玩具’是无法召回 sku='托马斯小火车’的。

通俗的讲就是训练一个模型，该模型通过将 query 和 sku 映射到统一维度空间，在该空间中，相似的商品距离近，不相近的商品距离较远。

我们得到了 query 和 sku 的向量，接下来就是做检索，返回与 query 距离近的 topK 个 sku。而数据库的商品量非常多，通常是十亿级，不可能做线性遍历，考虑到时效性，会引入快速向量近似检索方法，如 KDTree、TDM、LSH、PQ、HNSW 等等，我们采用的是 PQ 算法，这里不再赘述，网上有很多材料介绍其算法。下面重点介绍我们的模型及在线检索框架。

#### 注：英文原名Inverted index，大概因为 Invert 有颠倒的意思，就被翻译成了倒排。反向索引更合适
一个未经处理的数据库中，一般是以文档ID作为索引，以文档内容作为记录。
而Inverted index 指的是将单词或记录作为索引，将文档ID作为记录，这样便可以方便地通过单词或记录查找到其所在的文档。

### 3.模型结构，详见参考
离线索引 ( offline indexing )，使用的是 sku tower，导出 sku 的 embedding 构建 QP 索引。
在线服务 ( online serving ) 使用的是 query tower，模型加载在 tensorflow service，在线 predict query 的 embedding。

模型结构，一个 query tower Q，一个 sku tower S。  
双塔模型训练完后，query 和 sku 的模型相对独立，我们可以分别计算他们。  
所有的 sku embedding 都在离线计算，以便快速构建向量检索索引。  
**虽然 model 是相互独立的，但 query 和 sku 之间使用简单的点积计算，理论上 query 和 sku embedding 仍然在同一个几何空间中，具有可比性**。

#### Query tower with multi heads
我们看到左侧的 tower 和右侧有两点不一样：Projection layer 和 mutli heads，目的是为了丰富 query 侧的信息。  
如下图所示，不同的 head 可以捕获 query 不同的语义 ( query= 苹果，语义可以是手机和水果 )，捕获不同的品牌属性 ( query= 手机，品牌可以是华为、小米 )，捕获不同的产品属性 ( query= 三星，产品属性可以是笔记本、手机 ) 等等。
#### 训练优化
尝试过更强大的神经网络，如 RNN、transform 等，得到的效果类似或稍好一些。  
**然而一个短延时的模型更适用于工业生产建模，这样可以使用更少的服务器做有效的离线训练和在线服务**。

### 4.商品排序
商品排序主要是根据用户的输入对商品进行打分排序。

**商品排序的传统方法使用 xgboost 等基于决策树的方法从数据中进行学习，但是这些模型通常有成百乃至上千的数值型人工特征，不能有效的从原始特征比如用户历史点击购买数据、商品文本和图像中直接学习**。  

近年来，深度学习在各种应用中验证了从原始特征中学习的有效性，在业界被广泛使用，比如 wide&Deep、DIN 等。下面介绍一个我们在商品搜索排序中尝试的方法。



&nbsp;
## References
[京东电商搜索中的语义检索与商品排序](https://www.infoq.cn/article/pbWjRdjjShU2JuzClCeU?utm_source=related_read_bottom&utm_medium=article)
