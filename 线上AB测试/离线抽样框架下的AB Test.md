在 AB Test 的语境中，“离线抽样”指在实验开始之前就确定实验组和对照的抽样方式。很显然，离线抽样的对象不是实时产生的流量，相反，离线抽样框架下的 AB Test 更接近于传统自然科学和社会科学中的实验, 比如农业学家在分析不同土地条件对农作物的影响时，会事先划分好土地以进行不同的干预。总体而言，离线抽样框架下的 AB Test 与在线分流框架下的 AB Test 在分析逻辑上是高度一致的，但由于应用场景的特殊性，离线抽样框架下的 AB Test 会面临一些特别的挑战，因此可能需要采用一些有别于流量实验的实验技术。
## 1、为什么需要离线抽样?
离线抽样最常见的场景是一些能让用户明显感知到差异的产品变化。为了防止用户体验出现不一致，研究者必须确保同一个用户在整个实验期间的分组情况不会发生改变，因此在这个场景下，随机化的单位是用户，而不是用户的每次访问，用户的分组在实验开始前就定下来了，并贯穿实验始终。

除了产品变化，用户运营活动一般也需要离线抽样，比如：在测试发红包对广告客户活跃度有促进作用的实验中，一个客户或者得到红包，或者没有得到红包，这是由研究者事先决定的。

当然，离线抽样的对象也有可能是其它的事物，比如广告主所建立的广告计划、算法工程师创造出的用户标签等。

总结以上的业务场景可知，只要当某个干预手段的影响范围超出了单次用户访问，研究者就很有可能需要通过离线抽样的方式来保证干预对象（无论是用户、广告计划还是标签）所属的分组身份在整个实验过程中保持一致。

&nbsp;
## 2、离线抽样的主要难点
相比起在线分流，离线抽样面临众多挑战，最主要的挑战是抽样对象数量不足、抽样对象群体的差异性和干预的非随机性。
### 2.1 抽样对象数量不足问题
一般来说，离线抽样的对象数量与在线分流的分流对象数量相差至少一个数量级。以针对用户的抽样为例，用户对主流互联网产品的访问频率在一天几次到几十次之间，因此在一到两周的实验周期中，用户数量往往只是流量数量的的几十分之一。

而在对B端用户的产品变化或者运营活动中，会有更严重的数量不足问题。大多数主流互联网经营的是多边平台 —— 平台的C端用户是大量的消费者，B端用户如电商商家、广告主等则在数量上少很多。

抽样对象数量不足会直接导致 AB Test 的功效（power）不足。统计检验的功效（statistical power）的定义是：当备择假设为真时，检验能正确拒绝原假设的概率。任何一个合理的检验都会满足一个基本条件：检验的功效是样本量的增函数，当样本量趋向无穷时，检验的功效趋向于1。该条件被称为一致性条件，也就是说，如果我们能获得无穷多的数据点，那么一个合理的检验是能让我们以无限接近于1的概率区分原假设和备择假设的。很显然，一致性条件是一个非常低的要求，我们之前介绍的各种检验，比如比较两个样本均值的 t - 检验，都符合一致性条件。之前文章介绍的最小样本量计算公式正是基于固定第二类错误概率 t 统计量的分布所得到的。
### 2.2 抽样对象的异质性问题
随机化抽样过程的目标是确保实验组和对照组在除了外在干预这一项之外，在其它方面都是差不多的。然而，如果抽样对象群体内部存在的巨大的异质性，那么实验组和对照组的相似性就不一定能保证了。有时少量极端数据点会使得实验组合对照组在主要指标上出现显著差异，这是在离线抽样中常常遇到的困难。

从统计学的角度来看，异质性问题的核心依然是抽样对象的数量不足。假设研究者有能力抽取任意多的样本，那么无论对象群体的异质性有多大，每一个细分群体都能被足够多的样本量所覆盖，实验组和对照组也就都能成为有代表性的样本。然而，当可供抽样的对象总数量不足时，研究者就无法通过增加样本量来消除实验组和对照组之间的差异了。

与此同时，离线抽样对象群体内部存的巨大异质性也通常符合商业规律。显然，商家与商家之间的差异，要远大于消费者与消费者之间的差异，而后者间的差异又大于各消费者的每一次浏览之间的差异。商家在 GMV、广告消耗额、活跃用户数等主要指标上的分布与幂律分布高度吻合，一个样本中的加总指标被少数头部商家所驱动，它们被分在实验组还是对照组就可能对实验产生重大影响。而相比之下，流量实验就的抽样对象异质性问题就轻得多。
### 2.3 干预的非随机性问题
干预的非随机化分配是 AB Test 的基础，而在一些业务场景中，却不一定可以保证干预分配的随机性。出现干预非随机分配主要有两种可能：

出于业务目的，实验的参与有一定门槛。最常见的例子是针对客户的运营活动，比如一些新权益的设置只针对广告消耗达到一定阈值的客户，但研究者依然希望计算新权益本身所产生的效应。这类场景中的“AB Test”其实只能算之前文章介绍过的“准实验”，在计算干预所产生的效应时需要校正干预分配过程中的非随机性。

实验对象是否接受干预在一定程度上取决于他们自身的行为。比如实验的内容是某个广告产品的定向能力的提升，而客户是否会受到该项改变的影响首先取决于客户是否使用该广告产品，但客户是否使用该产品并非随机选择。理想状态下，研究者既希望能分析定向能力的提升对广告产品采用率的影响，又希望能分析定向能力提升对广告效率本身的影响。难点在于，为了回答前一个问题而采取的客户抽样方式对回答后一个问题而言意味着干预的非随机性，反之亦然。

&nbsp;
## 3、应对离线抽样挑战的实验技术
### 3.1 方差缩减技术
方差缩减技术是针对抽样对象数量不足问题的有效解决方案。为了说明这一方法的原理，我们假定某个关键指标的统计量，比如样本均值的抽样分布（sampling distribution）如下图：
### 3.2 分层抽样和IPW
针对抽样对象的异质性问题，最直观的解决方法是首先将抽样对象群体进行划分，让每个细分群体接近于均质，然后再在每个细分群体中抽取实验组和对照组。这个方法就是分层抽样，在离线抽样中广为使用。
### 3.3 匹配方法
把分层抽样方法的思路推演到极致，就是匹配（matching）的思路。匹配方法同样非常符合直觉，我们不是担心实验组和对照组不够可比吗？那么我们干脆对每一个实验组中的个体，选取一个与它在各维度和指标上非常接近的个体放在对照组中，如此构造出来的对照组就与实验组非常接近了。

上述过程被称为直接匹配，如果能够实现，不但能够较好地解决抽样对象的异质性问题，而且能够实现方差缩减，更重要的是，能够在很大程度上解决干预的非随机性问题。

干预的非随机性问题，从统计学的角度来看，就是混杂变量（counfounding factor）对因果推断的干扰问题。

&nbsp;
## 4、总结
在互联网业务中，流量之外的分析对象同样需要大量的 AB Test 分析，这些 AB Test 的主要特征是需要在实验开始之前就要完成对实验组和对照组的抽取。离线抽样的主要困难是抽样对象数量的不足、抽样对象的巨大差异性和干预非随机。通过方差缩减、分层抽样、IPW和匹配，我们在一定程度上可以应对这些困难。当然，离线抽样的技术相比起在线分流技术依然成熟度较低，无论在理论上还是实用技术上还有很大的发展空间。

&nbsp;
## References
[【阿里妈妈数据科学系列】第三篇：离线抽样框架下的AB Test](https://mp.weixin.qq.com/s/BsZlamzsYs-asvUGtF5sUQ)
