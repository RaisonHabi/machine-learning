## 损失函数
### 1.skip-gram
<p><img src="https://www.zhihu.com/equation?tex=%5Chat%7By%7D" alt="\hat{y}" eeimg="1"/> 的值代表了 <img src="https://www.zhihu.com/equation?tex=w_c" alt="w_c" eeimg="1"/> 附近各词出现的概率，那么我们希望window里出现的单词的概率尽量高些，假设window中各词出现的事件<b>条件独立</b>，对条件概率函数取负对数：</p><p><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Balign%2A%7D+%5Ctext%7Bminimize%7D%5Cquad+J%26%3D-%5Cln+P%28w_%7Bc-m%7D%2C+%5Cdots%2Cw_%7Bc-1%7D%2Cw_%7Bc%2B1%7D%2C%5Cdots%2Cw_%7Bc%2Bm%7D%7Cw_c%29%5C%5C+%09%09%09%09%26%3D-%5Cln+%5Cprod_%7Bj%3D0%2C+j%5Cneq+m%7D%5E%7B2m%7D+P%28w_%7Bc-m%2Bj%7D%7Cw_c%29%5C%5C+%09%09%09%09%26%3D-%5Csum_%7Bj%3D0%2C+j%5Cneq+m%7D%5E%7B2m%7D+%5Cln+P%28u_%7Bc-m%2Bj%7D%7Cv_c%29%5C%5C+%09%09%09%09%26%3D-%5Csum_%7Bj%3D0%2C+j%5Cneq+m%7D%5E%7B2m%7D+%5Cln%5Cleft%28%5Cfrac%7B%5Cexp%7B%28u_%7Bc-m%2Bj%7D%27v_c%29%7D%7D%7B%5Csum_%7Bk%3D1%7D%5EV+%5Cexp%28u_k%27v_c%29%7D%5Cright%29%5C%5C+%09%09%09%09%26%3D-%5Csum_%7Bj%3D0%2C+j%5Cneq+m%7D%5E%7B2m%7D+%5Cleft%5Bu_%7Bc-m%2Bj%7D%27v_c+%2B%5Cln%5Cleft%28%5Csum_%7Bk%3D1%7D%5EV+%5Cexp%28u_k%27v_c%29%5Cright%29%5Cright%5D%5C%5C+%09J_o+%26%3D+-u_o%27v_c+%2B%5Cln%5Cleft%28%5Csum_%7Bk%3D1%7D%5EV+%5Cexp%28u_k%27v_c%29%5Cright%29+%5Cend%7Balign%2A%7D" alt="\begin{align*} \text{minimize}\quad J&amp;=-\ln P(w_{c-m}, \dots,w_{c-1},w_{c+1},\dots,w_{c+m}|w_c)\\ 				&amp;=-\ln \prod_{j=0, j\neq m}^{2m} P(w_{c-m+j}|w_c)\\ 				&amp;=-\sum_{j=0, j\neq m}^{2m} \ln P(u_{c-m+j}|v_c)\\ 				&amp;=-\sum_{j=0, j\neq m}^{2m} \ln\left(\frac{\exp{(u_{c-m+j}&#39;v_c)}}{\sum_{k=1}^V \exp(u_k&#39;v_c)}\right)\\ 				&amp;=-\sum_{j=0, j\neq m}^{2m} \left[u_{c-m+j}&#39;v_c +\ln\left(\sum_{k=1}^V \exp(u_k&#39;v_c)\right)\right]\\ 	J_o &amp;= -u_o&#39;v_c +\ln\left(\sum_{k=1}^V \exp(u_k&#39;v_c)\right) \end{align*}" eeimg="1"/> </p><p>不考虑概率解释的话，损失函数其实就是根据 <img src="https://www.zhihu.com/equation?tex=%5Chat%7By%7D%2C%5C+y_o" alt="\hat{y},\ y_o" eeimg="1"/> 算一个交叉熵损失。（注意 <img src="https://www.zhihu.com/equation?tex=y_i" alt="y_i" eeimg="1"/> 就是一个one-hot向量）</p>

<ul><li>对W&#39;求导</li></ul><p><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Balign%2A%7D+%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+u_o%7DJ_o+%26%3D+-v_c+%2B+%5Cfrac%7B%5Cexp%28u_o%27v_c%29%7D%7B%5Csum_%7Bk%3D1%7D%5EV+%5Cexp%28u_k%27v_c%29%7Dv_c%3D-%28%5Chat%7By%7D_o-1%29v_c%5C%5C+%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+u_i%7DJ_o+%26%3D+%5Cfrac%7B%5Cexp%28u_i%27v_c%29%7D%7B%5Csum_%7Bk%3D1%7D%5EV+%5Cexp%28u_i%27v_c%29%7Dv_c%5C+%28i%5Cneq+o%29%3D-%28%5Chat%7By%7D_i-0%29v_c%5C%5C+%5CRightarrow+%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+W%27%7D+J_o+%26%3D+v_c+%28%5Chat%7By%7D+-+y_o%29%27+%5Cend%7Balign%2A%7D" alt="\begin{align*} \frac{\partial}{\partial u_o}J_o &amp;= -v_c + \frac{\exp(u_o&#39;v_c)}{\sum_{k=1}^V \exp(u_k&#39;v_c)}v_c=-(\hat{y}_o-1)v_c\\ \frac{\partial}{\partial u_i}J_o &amp;= \frac{\exp(u_i&#39;v_c)}{\sum_{k=1}^V \exp(u_i&#39;v_c)}v_c\ (i\neq o)=-(\hat{y}_i-0)v_c\\ \Rightarrow \frac{\partial}{\partial W&#39;} J_o &amp;= v_c (\hat{y} - y_o)&#39; \end{align*}" eeimg="1"/> </p><p>可以看到，对W&#39;求导只需要算一个向量外积</p><ul><li>对W求导</li></ul><p><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Balign%2A%7D+%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+v_c%7DJ_o+%26%3D+-u_o+%2B+%5Csum_%7Bs%3D1%7D%5EV+%5Cfrac%7B%5Cexp%28u_s%27v_c%29%7D%7B%5Csum_%7Bk%3D1%7D%5EV+%5Cexp%28u_k%27v_c%29%7Du_s%5C%5C+%09%26%3D-u_o+%2B+%5Csum_%7Bs%3D1%7D%5EV+%5Chat%7By%7D_s+u_s+%3D+-u_o+%2B+%5Csum_%7Bs%3D1%7D%5EV+p%28s%7Cc%29u_s%5C%5C+%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+v_i%7DJ_o+%26%3D+0%5C+%28i%5Cneq+c%29%5C%5C+%5Cend%7Balign%2A%7D" alt="\begin{align*} \frac{\partial}{\partial v_c}J_o &amp;= -u_o + \sum_{s=1}^V \frac{\exp(u_s&#39;v_c)}{\sum_{k=1}^V \exp(u_k&#39;v_c)}u_s\\ 	&amp;=-u_o + \sum_{s=1}^V \hat{y}_s u_s = -u_o + \sum_{s=1}^V p(s|c)u_s\\ \frac{\partial}{\partial v_i}J_o &amp;= 0\ (i\neq c)\\ \end{align*}" eeimg="1"/> </p><p>只有第c行的梯度非零，所以每次做反向传播，只需要更新W的一行元素即可。</p>

### 2.cbow
<p><img src="https://www.zhihu.com/equation?tex=%5Chat%7By%7D_c" alt="\hat{y}_c" eeimg="1"/> 相当于我们对 <img src="https://www.zhihu.com/equation?tex=P%28w_c%7Cw_%7Bc-m%7D%2C%5Cdots%2Cw%7Bc-1%7D%2Cw_%7Bc%2B1%7D%2C%5Cdots%2Cw_%7Bc%2Bm%7D%29" alt="P(w_c|w_{c-m},\dots,w{c-1},w_{c+1},\dots,w_{c+m})" eeimg="1"/> 的估计，对其取负对数:</p><p><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Balign%2A%7D+%5Ctext%7Bminimize%7D%5Cquad+J%26%3D-%5Cln+P%28w_c%7Cw_%7Bc-m%7D%2C%5Cdots%2Cw%7Bc-1%7D%2Cw_%7Bc%2B1%7D%2C%5Cdots%2Cw_%7Bc%2Bm%7D%29%5C%5C+%09%09%09%09%26%3D-%5Cln+P%28u_c%7C%5Chat%7Bv%7D%29%5C%5C+%09%09%09%09%26%3D-%5Cln+%5Cfrac%7B%5Cexp%28u_c%27%5Chat%7Bv%7D%29%7D%7B%5Csum_%7Bk%3D1%7D%5EV+%5Cexp%28u_k%27%5Chat%7Bv%7D%29%7D%5C%5C+%09%09%09%09%26%3D-u_c%27%5Chat%7Bv%7D%2B%5Cln+%5Csum_%7Bk%3D1%7D%5EV+%5Cexp%28u_k%27%5Chat%7Bv%7D%29+%5Cend%7Balign%2A%7D" alt="\begin{align*} \text{minimize}\quad J&amp;=-\ln P(w_c|w_{c-m},\dots,w{c-1},w_{c+1},\dots,w_{c+m})\\ 				&amp;=-\ln P(u_c|\hat{v})\\ 				&amp;=-\ln \frac{\exp(u_c&#39;\hat{v})}{\sum_{k=1}^V \exp(u_k&#39;\hat{v})}\\ 				&amp;=-u_c&#39;\hat{v}+\ln \sum_{k=1}^V \exp(u_k&#39;\hat{v}) \end{align*}" eeimg="1"/> </p>

<ul><li>对W&#39;求导</li></ul><p><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Balign%2A%7D+%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+W%27%7D+J+%26%3D+%5Chat%7Bv%7D%28%5Chat%7By%7D+-+y_c%29%27+%5Cend%7Balign%2A%7D" alt="\begin{align*} \frac{\partial}{\partial W&#39;} J &amp;= \hat{v}(\hat{y} - y_c)&#39; \end{align*}" eeimg="1"/> </p><ul><li>对W求导</li></ul><p><img src="https://www.zhihu.com/equation?tex=%5Cbegin%7Balign%2A%7D+%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+v_j%7DJ+%26%3D+%5Cfrac%7B1%7D%7B2m%7D%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+%5Chat%7Bv%7D%7DJ%5Cquad+j+%5Cin+%5Ctext%7Bwindow%7D%5C%5C+%09%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+%5Chat%7Bv%7D%7DJ%26%3D-u_c+%2B+%5Csum_%7Bs%3D1%7D%5EV+%5Cfrac%7B%5Cexp%7Bu_s%27%5Chat%7Bv%7D%7D%7D%7B%5Csum_%7Bk%3D1%7D%5EV+u_k%27%5Chat%7Bv%7D%7Du_s%5C%5C+%09%26%3D-u_c+%2B+%5Csum_%7Bs%3D1%7D%5EV+P%28s%7C%5Ctext%7Bwindow%7D%29u_s%5C%5C+%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial+v_j%7DJ+%26%3D+0+%5Cquad+j+%5Cnotin+%5Ctext%7Bwindow%7D+%5Cend%7Balign%2A%7D" alt="\begin{align*} \frac{\partial}{\partial v_j}J &amp;= \frac{1}{2m}\frac{\partial}{\partial \hat{v}}J\quad j \in \text{window}\\ 	\frac{\partial}{\partial \hat{v}}J&amp;=-u_c + \sum_{s=1}^V \frac{\exp{u_s&#39;\hat{v}}}{\sum_{k=1}^V u_k&#39;\hat{v}}u_s\\ 	&amp;=-u_c + \sum_{s=1}^V P(s|\text{window})u_s\\ \frac{\partial}{\partial v_j}J &amp;= 0 \quad j \notin \text{window} \end{align*}" eeimg="1"/> </p><p>CBOW更新W的时候只需要将在window里面单词对应的行向量统一更新即可。</p>

&nbsp;
## reference
[深入word2vec，从统计原理到训练过程](https://zhuanlan.zhihu.com/p/56176647)
